name: Auto Merge PR

on:
  check_suite:
    types: [completed]

jobs:
  automerge:
    if: >
      github.event.check_suite.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Find PR for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:dev`
            });

            if (prs.data.length === 0) {
              core.info('No open PR from dev â†’ master');
              return;
            }

            const pr = prs.data[0];

            const hasLabel = pr.labels.some(l => l.name === 'Auto Merge');
            if (!hasLabel) {
              core.info('PR does not have automerge label');
              return;
            }

            if (pr.base.ref !== 'master') {
              core.info('PR is not targeting master');
              return;
            }

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              merge_method: 'squash'
            });

            core.info(`PR #${pr.number} merged successfully`);
